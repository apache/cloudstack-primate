// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.

<template>
  <a-spin :spinning="fetchLoading">
    <a-tabs :tabPosition="device === 'tablet' ? 'top' : 'left'" :animated="false" @change="handleFetchData">
      <a-tab-pane tab="Private Gateways" key="pgw" v-if="'listPrivateGateways' in $store.getters.apis">
        <a-button
          type="dashed"
          icon="plus"
          style="width: 100%"
          @click="() => handleOpenModals('privateGateways')">Add Private Gateway</a-button>
        <a-list class="list">
          <a-list-item v-for="item in privateGateways" :key="item.id">
            <div class="list__item">
              <div class="list__col">
                <div class="list__label">{{ $t('ip') }}</div>
                <div>
                  <router-link :to="{ path: '/privategw/' + item.id }">{{ item.ipaddress }}</router-link>
                </div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('state') }}</div>
                <div><status :text="item.state" displayText></status></div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('gateway') }}</div>
                <div>{{ item.gateway }}</div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('netmask') }}</div>
                <div>{{ item.netmask }}</div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('vlan') }}</div>
                <div>{{ item.vlan }}</div>
              </div>
            </div>
          </a-list-item>
        </a-list>
        <a-modal v-model="modals.gateway" :title="$t('label.add.new.gateway')" @ok="handleGatewayFormSubmit">
          <a-spin :spinning="modals.gatewayLoading">
            <p>{{ $t('message.add.new.gateway.to.vpc') }}</p>
            <a-form @submit.prevent="handleGatewayFormSubmit" :form="gatewayForm">
              <a-form-item :label="$t('physicalnetworkid')">
                <a-select v-decorator="['physicalnetwork']">
                  <a-select-option v-for="item in physicalnetworks" :key="item.id" :value="item.id">
                    {{ item.name }}
                  </a-select-option>
                </a-select>
              </a-form-item>
              <a-form-item :label="$t('label.vlan')" :required="true">
                <a-input
                  :placeholder="placeholders.vlan"
                  v-decorator="['vlan', {rules: [{ required: true, message: 'Required' }]}]"
                ></a-input>
              </a-form-item>
              <a-form-item :label="$t('publicip')" :required="true">
                <a-input
                  :placeholder="placeholders.ipaddress"
                  v-decorator="['ipaddress', {rules: [{ required: true, message: 'Required' }]}]"
                ></a-input>
              </a-form-item>
              <a-form-item :label="$t('gateway')" :required="true">
                <a-input
                  :placeholder="placeholders.gateway"
                  v-decorator="['gateway', {rules: [{ required: true, message: 'Required' }]}]"
                ></a-input>
              </a-form-item>
              <a-form-item :label="$t('netmask')" :required="true">
                <a-input
                  :placeholder="placeholders.netmask"
                  v-decorator="['netmask', {rules: [{ required: true, message: 'Required' }]}]"
                ></a-input>
              </a-form-item>
              <a-form-item :label="$t('sourceNat')">
                <a-checkbox v-decorator="['nat']"></a-checkbox>
              </a-form-item>
              <a-form-item :label="$t('aclid')">
                <a-select v-decorator="['acl']">
                  <a-select-option v-for="item in networkAcls" :key="item.id" :value="item.id">
                    {{ item.name }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-form>
          </a-spin>
        </a-modal>
      </a-tab-pane>
      <a-tab-pane tab="Public IP Addresses" key="ip" v-if="'listPublicIpAddresses' in $store.getters.apis">
        <a-button type="dashed" icon="plus" style="width: 100%" @click="handleAcquireNewIp">Acquire New IP</a-button>
        <a-list class="list">
          <a-list-item v-for="item in publicIpAddresses" :key="item.id">
            <div class="list__item">
              <div class="list__col">
                <div class="list__label">{{ $t('ip') }}</div>
                <div>
                  <router-link :to="{ path: '/publicip/' + item.id }">
                    {{ item.ipaddress }}
                    <a-tag v-if="item.issourcenat">source-nat</a-tag>
                    <a-tag v-if="item.isstaticnat">static-nat</a-tag>
                  </router-link>
                </div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('state') }}</div>
                <div><status :text="item.state" displayText></status></div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('vm') }}</div>
                <div>
                  <router-link :to="{ path: '/vm/' + item.virtualmachineid }">
                    {{ item.virtualmachinedisplayname || item.virtualmachinename }}
                  </router-link>
                </div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('network') }}</div>
                <div>
                  <router-link :to="{ path: '/guestnetwork/' + item.associatednetworkid }">
                    {{ item.associatednetworkname }}
                  </router-link>
                </div>
              </div>
            </div>
          </a-list-item>
        </a-list>
      </a-tab-pane>
      <a-tab-pane tab="S2S VPN Gateway" key="vpngw" v-if="'listVpnGateways' in $store.getters.apis">
        <a-button type="dashed" icon="plus" style="width: 100%">Create Site-to-Site VPN Gateway</a-button>
        TODO: the add/create button should be only shown when there are no gateways, otherwise show it.
        only clicking, it should fire createVpnGateway API with vpcid=resource.id as param
        <a-list class="list">
          <a-list-item v-for="item in vpnGateways" :key="item.id">
            <div class="list__item">
              <div class="list__col">
                <div class="list__label">{{ $t('ip') }}</div>
                <div>
                  <router-link :to="{ path: '/s2svpn/' + item.id }">
                    {{ item.publicip }}
                  </router-link>
                </div>
              </div>
            </div>
          </a-list-item>
        </a-list>
      </a-tab-pane>
      <a-tab-pane tab="S2S VPN Connection" key="vpnc" v-if="'listVpnConnections' in $store.getters.apis">
        <a-button
          type="dashed"
          icon="plus"
          style="width: 100%"
          @click="handleOpenModals('vpnConnection')">
          Create Site-to-Site VPN Connection
        </a-button>
        <a-table
          style="margin-top: 20px; overflow-y: auto"
          size="small"
          :columns="vpnConnectionsColumns"
          :dataSource="vpnConnections"
          :pagination="false"
          :rowKey="record => record.id">

          <a slot="publicip" slot-scope="text, record" href="javascript:;">
            <router-link :to="{ path: '/s2svpnconn/' + record.id }">
              {{ text }}
            </router-link>
          </a>
          <template slot="state" slot-scope="text">
            <status :text="text ? text : ''" displayText />
          </template>

        </a-table>
        <a-modal v-model="modals.vpnConnection" :title="$t('label.create.VPN.connection')" @ok="handleVpnConnectionFormSubmit">
          <a-spin :spinning="modals.vpnConnectionLoading">
            <a-form @submit.prevent="handleVpnConnectionFormSubmit" :form="vpnConnectionForm">
              <a-form-item :label="$t('vpncustomergatewayid')">
                <a-select v-decorator="['vpncustomergateway']">
                  <a-select-option v-for="item in vpncustomergateways" :key="item.id" :value="item.id">
                    {{ item.name }}
                  </a-select-option>
                </a-select>
              </a-form-item>
              <a-form-item :label="$t('passive')">
                <a-checkbox v-decorator="['passive']"></a-checkbox>
              </a-form-item>
            </a-form>
          </a-spin>
        </a-modal>
      </a-tab-pane>
      <a-tab-pane tab="Network ACL Lists" key="acl" v-if="'listNetworkACLLists' in $store.getters.apis">
        <a-button
          type="dashed"
          icon="plus"
          style="width: 100%"
          @click="() => handleOpenModals('networkAcl')">
          Add Network ACL List
        </a-button>
        <a-list class="list">
          <a-list-item v-for="item in networkAcls" :key="item.id">
            <div class="list__item">
              <div class="list__col">
                <div class="list__label">{{ $t('name') }}</div>
                <div>
                  <router-link :to="{ path: '/acllist/' + item.id }">
                    {{ item.name }}
                  </router-link>
                </div>
              </div>
              <div class="list__col">
                <div class="list__label">{{ $t('description') }}</div>
                <div>{{ item.description }}</div>
              </div>
            </div>
          </a-list-item>
        </a-list>
        <a-modal
          v-model="modals.networkAcl"
          :title="$t('label.add.acl.list')"
          @ok="handleNetworkAclFormSubmit">
          <a-form @submit.prevent="handleNetworkAclFormSubmit" :form="networkAclForm">
            <a-form-item :label="$t('label.add.list.name')">
              <a-input v-decorator="['name', {rules: [{ required: true, message: 'Required' }]}]"></a-input>
            </a-form-item>
            <a-form-item :label="$t('description')">
              <a-input v-decorator="['description', {rules: [{ required: true, message: 'Required' }]}]"></a-input>
            </a-form-item>
          </a-form>
        </a-modal>
      </a-tab-pane>
      <a-tab-pane tab="Virtual Routers" key="vr" v-if="'listRouters' in $store.getters.apis">
        <a-list>
          <a-list-item v-for="item in routers" :key="item.id">
            <div class="list__item">
              <div class="list__row">
                <div class="list__col">
                  <div class="list__label">{{ $t('name') }}</div>
                  <div>
                    <router-link :to="{ path: '/router/' + item.id }">
                      {{ item.name }}
                    </router-link>
                  </div>
                </div>
                <div class="list__col">
                  <div class="list__label">{{ $t('state') }}</div>
                  <div><status :text="item.state" displayText></status></div>
                </div>
                <div class="list__col">
                  <div class="list__label">{{ $t('publicip') }}</div>
                  <div>{{ item.publicip }}</div>
                </div>
                <div class="list__col">
                  <div class="list__label">{{ $t('redundantrouter') }}</div>
                  <div>{{ item.isredundantrouter }}</div>
                </div>
                <div class="list__col">
                  <div class="list__label">{{ $t('redundantstate') }}</div>
                  <div>{{ item.redundantstate }}</div>
                </div>
                <div class="list__col">
                  <div class="list__label">{{ $t('hostname') }}</div>
                  <div>
                    <router-link :to="{ path: '/host/' + item.hostid }">
                      {{ item.hostname }}
                    </router-link>
                  </div>
                </div>
              </div>
            </div>
          </a-list-item>
        </a-list>
      </a-tab-pane>
    </a-tabs>
  </a-spin>
</template>

<script>
import { api } from '@/api'
import Status from '@/components/widgets/Status'
import { mixinDevice } from '@/utils/mixin.js'

export default {
  name: 'VpcRouterTab',
  components: {
    Status
  },
  mixins: [mixinDevice],
  props: {
    resource: {
      type: Object,
      required: true
    },
    loading: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      routers: [],
      fetchLoading: false,
      privateGateways: [],
      publicIpAddresses: [],
      vpnGateways: [],
      vpnConnections: [],
      networkAcls: [],
      modals: {
        gateway: false,
        gatewayLoading: false,
        vpnConnection: false,
        vpnConnectionLoading: false,
        networkAcl: false
      },
      placeholders: {
        vlan: null,
        ipaddress: null,
        gateway: null,
        netmask: null
      },
      physicalnetworks: [],
      vpncustomergateways: [],
      vpnConnectionsColumns: [
        {
          title: this.$t('ip'),
          dataIndex: 'publicip',
          scopedSlots: { customRender: 'publicip' }
        },
        {
          title: this.$t('state'),
          dataIndex: 'state',
          scopedSlots: { customRender: 'state' }
        },
        {
          title: this.$t('gateway'),
          dataIndex: 'gateway'
        },
        {
          title: this.$t('ipsecpsk'),
          dataIndex: 'ipsecpsk'
        }
      ]
    }
  },
  beforeCreate () {
    this.gatewayForm = this.$form.createForm(this)
    this.vpnConnectionForm = this.$form.createForm(this)
    this.networkAclForm = this.$form.createForm(this)
  },
  mounted () {
    this.handleFetchData()
  },
  watch: {
    loading (newData, oldData) {
      if (!newData && this.resource.id) {
        this.handleFetchData()
      }
    }
  },
  methods: {
    handleFetchData (e) {
      switch (e) {
        case 'pgw':
          this.fetchPrivateGateways()
          break
        case 'ip':
          this.fetchPublicIpAddresses()
          break
        case 'vpngw':
          this.fetchVpnGateways()
          break
        case 'vpnc':
          this.fetchVpnConnections()
          break
        case 'acl':
          this.fetchAclList()
          break
        case 'vr':
          this.fetchRouters()
          break
        default:
          this.fetchPrivateGateways()
          break
      }
    },
    fetchRouters () {
      this.fetchLoading = true
      api('listRouters', { vpcid: this.resource.id, listAll: true }).then(json => {
        this.routers = json.listroutersresponse.router
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.fetchLoading = false
      })
    },
    fetchPrivateGateways () {
      this.fetchLoading = true
      api('listPrivateGateways', { vpcid: this.resource.id, listAll: true }).then(json => {
        this.privateGateways = json.listprivategatewaysresponse.privategateway
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.fetchLoading = false
      })
    },
    fetchPublicIpAddresses () {
      this.fetchLoading = true
      api('listPublicIpAddresses', {
        vpcid: this.resource.id,
        listAll: true,
        page: 1,
        pagesize: 500,
        forvirtualnetwork: true
      }).then(json => {
        this.publicIpAddresses = json.listpublicipaddressesresponse.publicipaddress
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.fetchLoading = false
      })
    },
    fetchVpnGateways () {
      this.fetchLoading = true
      api('listVpnGateways', {
        vpcid: this.resource.id,
        listAll: true,
        page: 1,
        pagesize: 500
      }).then(json => {
        this.vpnGateways = json.listvpngatewaysresponse.vpngateway
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.fetchLoading = false
      })
    },
    fetchVpnConnections () {
      this.fetchLoading = true
      api('listVpnConnections', {
        vpcid: this.resource.id,
        listAll: true,
        page: 1,
        pagesize: 500
      }).then(json => {
        this.vpnConnections = json.listvpnconnectionsresponse.vpnconnection
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.fetchLoading = false
      })
    },
    fetchAclList () {
      this.fetchLoading = true
      api('listNetworkACLLists', {
        vpcid: this.resource.id,
        listAll: true,
        page: 1,
        pagesize: 500
      }).then(json => {
        this.networkAcls = json.listnetworkacllistsresponse.networkacllist
        if (this.modals.gateway === true) {
          this.$nextTick(() => {
            this.gatewayForm.setFieldsValue({ acl: this.networkAcls[0].id })
          })
        }
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.fetchLoading = false
      })
    },
    fetchPhysicalNetworks () {
      this.modals.gatewayLoading = true
      api('listPhysicalNetworks', { zoneid: this.resource.zoneid }).then(json => {
        this.physicalnetworks = json.listphysicalnetworksresponse.physicalnetwork
        if (this.modals.gateway === true) {
          this.$nextTick(() => {
            this.gatewayForm.setFieldsValue({ physicalnetwork: this.physicalnetworks[0].id })
          })
        }
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.modals.gatewayLoading = false
      })
    },
    fetchVpnCustomerGateways () {
      this.modals.vpnConnectionLoading = true
      api('listVpnCustomerGateways', { listAll: true }).then(json => {
        this.vpncustomergateways = json.listvpncustomergatewaysresponse.vpncustomergateway
        if (this.modals.vpnConnection === true) {
          this.$nextTick(() => {
            this.vpnConnectionForm.setFieldsValue({ vpncustomergateway: this.vpncustomergateways[0].id })
          })
        }
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.modals.vpnConnectionLoading = false
      })
    },
    handleOpenModals (e) {
      switch (e) {
        case 'privateGateways':
          this.modals.gateway = true
          this.gatewayForm.resetFields()
          this.fetchAclList()
          this.fetchPhysicalNetworks()
          break
        case 'vpnConnection':
          this.modals.vpnConnection = true
          this.vpnConnectionForm.resetFields()
          this.fetchVpnCustomerGateways()
          this.fetchVpnGateways()
          break
        case 'networkAcl':
          this.modals.networkAcl = true
          this.networkAclForm.resetFields()
          break
      }
    },
    handleGatewayFormSubmit () {
      this.modals.gatewayLoading = true

      this.gatewayForm.validateFields(errors => {
        if (errors) {
          this.modals.gatewayLoading = false
          return
        }

        const data = this.gatewayForm.getFieldsValue()

        api('createPrivateGateway', {
          sourcenatsupported: data.nat,
          physicalnetworkid: data.physicalnetwork,
          vpcid: this.resource.id,
          ipaddress: data.ipaddress,
          gateway: data.gateway,
          netmask: data.netmask,
          vlan: data.vlan,
          aclid: data.acl
        }).then(response => {
          this.$store.dispatch('AddAsyncJob', {
            title: `Successfully added Private Gateway`,
            jobid: response.createprivategatewayresponse.jobid,
            status: 'progress'
          })
          this.$pollJob({
            jobId: response.createprivategatewayresponse.jobid,
            successMethod: () => {
              this.modals.gateway = false
            },
            errorMessage: 'Adding Private Gateway failed',
            errorMethod: () => {
              this.modals.gateway = false
            },
            loadingMessage: `Adding Private Gateway...`,
            catchMessage: 'Error encountered while fetching async job result',
            catchMethod: () => {
              this.modals.gateway = false
            }
          })
        }).catch(error => {
          this.$notification.error({
            message: 'Request Failed',
            description: error.response.headers['x-description']
          })
        }).finally(() => {
          this.modals.gatewayLoading = false
          this.modals.gateway = false
          this.handleFetchData()
        })
      })
    },
    handleAcquireNewIp () {
      this.fetchLoading = true
      api('associateIpAddress', { vpcid: this.resource.id }).then(response => {
        this.$store.dispatch('AddAsyncJob', {
          title: `Successfully acquired new IP`,
          jobid: response.associateipaddressresponse.jobid,
          status: 'progress'
        })
        this.$pollJob({
          jobId: response.associateipaddressresponse.jobid,
          successMethod: () => {
            this.fetchPublicIpAddresses()
          },
          errorMessage: 'Failed to acquire new IP',
          errorMethod: () => {
            this.fetchPublicIpAddresses()
          },
          loadingMessage: `Acquiring new IP...`,
          catchMessage: 'Error encountered while fetching async job result',
          catchMethod: () => {
            this.fetchPublicIpAddresses()
          }
        })
      }).catch(error => {
        this.$notification.error({
          message: 'Request Failed',
          description: error.response.headers['x-description']
        })
      }).finally(() => {
        this.fetchLoading = false
        this.fetchPublicIpAddresses()
      })
    },
    handleVpnConnectionFormSubmit () {
      this.fetchLoading = true
      this.modals.vpnConnection = false

      this.vpnConnectionForm.validateFields((errors, values) => {
        if (errors) {
          this.fetchLoading = false
          return
        }

        api('createVpnConnection', {
          s2svpngatewayid: this.vpnGateways[0].id,
          s2scustomergatewayid: values.vpncustomergateway,
          passive: values.passive ? values.passive : false
        }).catch(error => {
          this.$notification.error({
            message: 'Request Failed',
            description: error.response.headers['x-description']
          })
        }).finally(() => {
          this.fetchLoading = false
        })
      })
    },
    handleNetworkAclFormSubmit () {
      this.fetchLoading = true
      this.modals.networkAcl = false

      this.networkAclForm.validateFields((errors, values) => {
        if (errors) {
          this.fetchLoading = false
        }

        api('createNetworkACLList', {
          name: values.name,
          description: values.description,
          vpcid: this.resource.id
        }).then(response => {
          this.$store.dispatch('AddAsyncJob', {
            title: `Successfully added Network ACL List`,
            jobid: response.createnetworkacllistresponse.jobid,
            status: 'progress'
          })
          this.$pollJob({
            jobId: response.createnetworkacllistresponse.jobid,
            successMethod: () => {
              this.fetchLoading = false
            },
            errorMessage: 'Adding Network ACL List failed',
            errorMethod: () => {
              this.fetchLoading = false
            },
            loadingMessage: `Adding Network ACL List...`,
            catchMessage: 'Error encountered while fetching async job result',
            catchMethod: () => {
              this.fetchLoading = false
            }
          })
        }).catch(error => {
          this.$notification.error({
            message: 'Request Failed',
            description: error.response.headers['x-description']
          })
        }).finally(() => {
          this.fetchLoading = false
          this.fetchAclList()
        })
      })
    }
  }
}
</script>

<style lang="scss" scoped>
.list {

  &__item,
  &__row {
    display: flex;
    flex-wrap: wrap;
    width: 100%;
  }

  &__item {
    margin-bottom: -20px;
  }

  &__col {
    flex: 1;
    margin-right: 20px;
    margin-bottom: 20px;
  }

  &__label {
    font-weight: bold;
  }

}
</style>
